# RAG 智能知识库项目报告

## 1. 技术架构 (Technical Architecture)

本项目采用前后端分离架构，构建了一个基于 **混合检索 (Hybrid Search)** 和 **联网搜索增强** 的智能 RAG (Retrieval-Augmented Generation) 问答系统。

### 1.1 前端技术栈 (Frontend)

- **核心框架**: React 18 + Vite
- **开发语言**: TypeScript
- **状态管理**: Zustand
- **UI 组件库**: Ant Design (主要组件), Lucide React (图标)
- **样式方案**: Tailwind CSS (原子化 CSS), Framer Motion (动画交互)
- **网络请求**: Axios
- **Markdown 渲染**: React Markdown + Remark Gfm (支持表格、代码块等)
- **其他特性**:
  - **语音识别**: Web Speech API (Speech-to-Text)
  - **流式响应**: SSE (Server-Sent Events) 实时打字机效果
  - **引用高亮**: 自定义组件支持关键词高亮显示

### 1.2 后端技术栈 (Backend)

- **核心框架**: FastAPI (高性能异步 Python Web 框架)
- **ASGI 服务器**: Uvicorn
- **数据库**:
  - **关系型数据库**: SQLite (存储会话历史、文档元数据)
  - **ORM**: SQLAlchemy
- **AI & RAG 核心**:
  - **LangChain**: LLM 应用开发编排
  - **向量数据库**: ChromaDB (本地持久化存储)
  - **混合检索**: `BM25` (关键词检索, 结合 `jieba` 中文分词) + `Vector Search` (语义检索)
  - **联网搜索**: `DuckDuckGo Search` (用于本地知识库缺失时的兜底)
  - **LLM**: `ChatOpenAI`（OpenAI 接口规范，支持兼容 OpenAI 的第三方网关，通过 `OPENAI_API_BASE` 指定）
- **文档处理**:
  - **PyPDF**: PDF 解析
  - **文本切分**: `RecursiveCharacterTextSplitter`（按字符长度切分，默认 `chunk_size=1000`，`chunk_overlap=200`）
- **异步处理**: 全面采用 `async/await` 提升并发性能

### 1.3 数据流向与检索策略

1.  **文档处理流**:
    - 用户上传 PDF/TXT/MD -> 后端落盘保存（`data/uploads/{doc_id}_{filename}`）并创建文档记录（`status=processing`）
    - 解析文本 -> 文本切块 (Chunking) -> 为每个 chunk 写入元数据（`file_id`/`filename`）
    - 写入 ChromaDB 并持久化（`backend/data/chroma_db`）
    - BM25 索引采用“按需构建 + 全局缓存”策略：首次混合检索时从 ChromaDB 拉取全量文本构建 BM25，后续复用；上传/删除文档会自动失效缓存并重建。
2.  **智能问答流 (RAG Pipeline)**:
    - **第 1 步: 混合检索 (Hybrid Search)**
      - 同时发起向量检索 (Semantic Search) 和 BM25 关键词检索。
      - 使用 `EnsembleRetriever` 对结果进行加权融合（Reciprocal Rank Fusion，倒数排序融合；当前权重 `BM25:0.5 / Vector:0.5`），提取 Top-K 相关文档。
    - **第 2 步: 联网搜索兜底 (Web Search Fallback)**
      - 如果本地检索无结果，系统自动调用 DuckDuckGo 进行联网搜索，并在流式模式下先返回提示文本。
      - 联网搜索结果会被包装为结构化来源（包含 `title`/`url`），用于前端引用侧边栏展示。
    - **第 3 步: 答案生成**
      - 组装 Prompt (问题 + 上下文/搜索结果 + 近几轮对话历史) -> 调用 LLM -> 流式返回答案给前端。
    - **第 4 步: 通用知识兜底 (General Knowledge Fallback)**
      - 若本地检索与联网搜索均无有效内容，则启用“通用知识回答 + 免责声明”的兜底策略，避免编造知识库来源。

---

## 2. 后端接口文档 (Backend Interfaces)

API 路径统一前缀为 `/api/v1`，主要分为 RAG 核心、会话管理、文档管理三个模块。

### 2.1 RAG 核心 (RAG Core)

| 方法   | 路径               | 描述                                                              |
| :----- | :----------------- | :---------------------------------------------------------------- |
| `POST` | `/rag/upload`      | **文档上传**。支持多格式文件，自动完成解析、切分、向量化和存储。  |
| `POST` | `/rag/chat`        | **普通问答**。非流式接口，返回完整答案及来源片段（截断文本）。    |
| `POST` | `/rag/chat/stream` | **流式问答**。SSE 格式流式返回答案与结构化来源 (用于非会话模式)。 |

请求体约定：

- `/rag/chat`: `{ "query": string }`
- `/rag/chat/stream`: `{ "query": string, "history": Array<{ role: string, content: string }> }`

### 2.2 会话管理 (Conversations)

支持多轮对话和上下文记忆。

| 方法     | 路径                                    | 描述                                                       |
| :------- | :-------------------------------------- | :--------------------------------------------------------- |
| `GET`    | `/conversations/`                       | **获取会话列表**。支持分页。                               |
| `POST`   | `/conversations/`                       | **创建新会话**。                                           |
| `GET`    | `/conversations/{id}`                   | **获取会话详情**。包含完整的历史消息记录。                 |
| `DELETE` | `/conversations/{id}`                   | **删除会话**。                                             |
| `POST`   | `/conversations/{id}/chat`              | **会话内聊天**。SSE 流式返回答案并自动落库（含引用来源）。 |
| `DELETE` | `/conversations/{id}/messages/{msg_id}` | **删除单条消息**。                                         |

会话流式接口补充：

- 请求体：`{ "query": string }`
- SSE 数据：中间分片为 `{ answer?: string, sources?: any[] }`，结束时会额外发送 `{ message_id: number, user_message_id: number }` 便于前端对齐消息。

### 2.3 文档管理 (Documents)

| 方法     | 路径                      | 描述                                                     |
| :------- | :------------------------ | :------------------------------------------------------- |
| `GET`    | `/documents/`             | **获取文档列表**。包含上传时间、状态、文件大小等元数据。 |
| `GET`    | `/documents/{id}/preview` | **预览文档**。返回文件流（PDF/Markdown/Text，inline）。  |
| `DELETE` | `/documents/{id}`         | **删除文档**。级联删除数据库记录、本地文件和向量库索引。 |

---

## 3. 产品功能 (Product Features)

### 3.1 智能问答 (Smart Q&A)

- **混合检索增强**: 结合语义理解和精确关键词匹配，显著提升回答准确率。
- **联网搜索兜底**: 当本地知识库无法回答时，自动联网搜索最新信息，减少“幻觉”和“不知道”。
- **流式响应**: 实时打字机效果，极速反馈。
- **引用溯源**:
  - 答案下方展示引用来源卡片。
  - 支持 **引用高亮**：点击引用可展开详情，并自动高亮与问题相关的关键词。
  - 明确标识来源类型（“本地文档”或“Web 搜索”）。
- **多模态输入**: 支持语音输入 (ASR)，自动转换为文字。

### 3.2 知识库管理

- **多格式支持**: 支持 PDF, TXT, MD 等格式。
- **可视化管理**: 实时查看文档处理状态 (Processing/Processed/Error)。
- **文档预览**: 内置文档预览器，无需下载即可查看原始内容。
- **智能清理**: 删除文档时自动清理对应的向量数据，保持知识库纯净。

### 3.3 会话历史

- **持久化存储**: 所有聊天记录存入 SQLite 数据库。
- **侧边栏导航**: 快速切换历史会话，支持新建和删除会话。
- **上下文记忆**: 机器人能理解多轮对话中的上下文关系。

---

## 4. 数据库设计 (Database Design)

系统使用 SQLite，核心表结构如下：

### 4.1 Conversations (会话表)

| 字段名       | 类型          | 描述     |
| :----------- | :------------ | :------- |
| `id`         | String (UUID) | 主键     |
| `title`      | String        | 会话标题 |
| `created_at` | DateTime      | 创建时间 |
| `updated_at` | DateTime      | 更新时间 |

### 4.2 Messages (消息表)

| 字段名            | 类型        | 描述                                                     |
| :---------------- | :---------- | :------------------------------------------------------- |
| `id`              | Integer     | 主键                                                     |
| `conversation_id` | String      | 外键，关联会话                                           |
| `role`            | String      | `user` 或 `assistant`                                    |
| `content`         | Text        | 消息内容                                                 |
| `sources`         | Text (JSON) | 存储 RAG 检索到的参考源 (包含 content, source, score 等) |
| `created_at`      | DateTime    | 发送时间                                                 |

### 4.3 Documents (文档表)

| 字段名        | 类型     | 描述                               |
| :------------ | :------- | :--------------------------------- |
| `id`          | Integer  | 主键                               |
| `filename`    | String   | 文件名                             |
| `file_size`   | Integer  | 文件大小                           |
| `status`      | String   | `processing`, `processed`, `error` |
| `upload_time` | DateTime | 上传时间                           |

---

## 5. 项目目录结构 (Project Structure)

```text
RAG/
├── backend/                        # 后端项目 (Python/FastAPI)
│   ├── app/
│   │   ├── api/
│   │   │   └── endpoints/          # API 路由模块 (chat, docs, rag)
│   │   ├── core/                   # 核心配置 (Config, DB)
│   │   ├── models/                 # SQLAlchemy 数据模型
│   │   ├── schemas/                # Pydantic 数据验证模型
│   │   └── services/               # 核心业务逻辑
│   │       ├── rag_engine.py       # RAG 核心引擎 (包含 Fallback 逻辑)
│   │       ├── vector_store.py     # 向量库管理 (Chroma + BM25)
│   │       ├── web_search.py       # 联网搜索服务 (DuckDuckGo)
│   │       └── ...
│   ├── data/                       # 数据存储 (SQLite, Uploads)
│   ├── tests/                      # 测试用例
│   ├── main.py                     # 应用入口
│   └── requirements.txt            # Python 依赖
├── frontend/                       # 前端项目 (React/Vite)
│   ├── src/
│   │   ├── components/             # UI 组件
│   │   │   ├── ReferenceSidebar.tsx # 引用展示与高亮组件
│   │   │   └── ...
│   │   ├── store/                  # 状态管理 (Zustand)
│   │   ├── services/               # API 请求封装
│   │   └── ...
│   └── package.json
├── docker-compose.yml              # Docker 一键部署
├── Jenkinsfile                     # CI/CD 示例（Jenkins）
├── DEPLOY_DOC.md                   # 部署说明
└── 知识库项目分析报告.md            # 项目报告
```

---

## 6. 部署指南 (Deployment Guide)

### 6.1 后端启动

1.  进入后端目录: `cd backend`
2.  创建虚拟环境: `python -m venv venv && source venv/bin/activate`
3.  安装依赖: `pip install -r requirements.txt`
4.  配置环境变量:
    - 复制 `.env.example` 为 `.env`
    - 配置 `OPENAI_API_KEY` (必填)
    - 可选配置 `OPENAI_API_BASE`（OpenAI 兼容网关地址）
    - 可选配置 `LLM_MODEL_NAME` / `EMBEDDING_MODEL_NAME`
    - 可选配置代理 `HTTP_PROXY` (如需联网搜索)
5.  启动服务: `uvicorn app.main:app --reload` (http://localhost:8000)

### 6.2 前端启动

1.  进入前端目录: `cd frontend`
2.  安装依赖: `npm install`
3.  启动开发服务器: `npm run dev` (http://localhost:5173)

### 6.3 Docker 部署（推荐）

项目提供 `docker-compose.yml`，包含：

- `backend`: FastAPI 服务（容器内 `8000`），挂载 `backend/data` 持久化 SQLite 与 ChromaDB
- `frontend`: Nginx 静态站点（对外暴露 `80`），并将 `/api/` 反向代理到 `backend:8000`

---

## 7. 未来规划 (Future Roadmap)

- **多模型切换**: 支持在界面上动态切换不同的 LLM 模型 (如 Claude, Gemini, Llama)。
- **知识图谱 (Knowledge Graph)**: 引入知识图谱增强文档间的关联分析。
- **权限管理**: 增加用户登录与多租户数据隔离。
- **更多数据源**: 支持 Notion, URL 爬虫等数据导入。

---

## 8. 未来规范（Engineering Standards）

本节用于指导后续迭代在“可维护性、可扩展性、可观测性、安全性”上的统一落地标准。

### 8.1 API 规范（API Contract，接口契约）

- **统一前缀与版本**: 所有接口保持 `/api/v1` 前缀，新增破坏性变更时升级版本。
- **请求与响应模型**: 使用 Pydantic 明确定义入参/出参；字段命名统一采用 snake_case（与 FastAPI 默认 JSON 输出一致）。
- **错误返回**: 统一返回 `HTTPException`，并约定 `detail` 为可读错误信息；前端对 `detail` 做兜底展示，避免白屏。
- **流式协议**: SSE 统一使用 `data: <json>\n\n`；约定 chunk 结构（`answer` 分片、`sources` 最终列表、`error` 错误）。
- **幂等与副作用**: 删除类接口必须幂等（重复删除返回 404 或 ok=false 也可接受，但需要统一约定）。

### 8.2 前端规范（Frontend Standards）

- **样式统一**: 以 Tailwind CSS 为主（原子化 CSS），Ant Design 仅用于复杂交互组件（Modal/Table/Message 等）。
- **状态分层**: 会话、消息流式状态统一收敛到 Zustand；组件内部仅保存 UI 局部状态（展开/收起、弹窗开关等）。
- **健壮性**: 所有从后端返回的可选字段使用可选链（?.）读取，任何异常数据都不应导致白屏。
- **流式渲染**: 统一通过 TextDecoder + buffer 解析 SSE；对解析失败的行仅告警，不中断整体渲染。
- **可访问性**: 表单与按钮补充 aria-label；键盘可操作；颜色对比度满足 WCAG（Web Content Accessibility Guidelines，网页内容无障碍指南）基本要求。

### 8.3 检索与知识库规范（Retrieval & Indexing）

- **Chunk 策略可配置**: chunk_size/chunk_overlap 通过环境变量可配置，并在 UI 中展示当前策略（便于排障）。
- **元数据一致性**: 所有向量入库必须携带 `file_id`/`filename`，以支持删除、溯源、引用跳转。
- **检索可解释性**: sources 结构保持可扩展（本地文档/网页来源），并确保能在前端展示 title、url、file_id。
- **缓存策略**: BM25 缓存需要明确失效条件（新增/删除文档）；当数据规模增大时，避免每次从 Chroma 拉全量构建。

### 8.4 安全与合规（Security & Compliance）

- **密钥管理**: `OPENAI_API_KEY` 仅通过环境变量/`.env` 提供，严禁写入仓库与日志。
- **CORS 收敛**: 生产环境 `allow_origins` 必须收敛到指定域名，避免任意来源调用。
- **上传安全**: 限制上传文件大小、MIME 类型与扩展名一致性；必要时做内容扫描（如 PDF 恶意 payload）。
- **审计日志**: 关键操作（上传、删除、会话删除）记录操作时间与结果（不记录敏感内容）。

### 8.5 测试与质量（Testing & Quality）

- **单测优先**: 以 services 层为单测重点（切分、入库、检索融合、兜底策略）。
- **可测性设计**: 支持 Mock 模式（无需真实 Key）以覆盖前端/后端联调与 CI。
- **质量门禁**: 前端执行 `npm run lint` 与 `npm run build`；后端执行格式化与基础测试（如 `black` + `pytest`）。

### 8.6 可观测性（Observability，可观测性）

- **统一日志**: 后端使用标准 logging，按 request_id 关联一次请求的完整链路（检索、联网、生成）。
- **关键指标**: 记录检索耗时、生成耗时、命中来源类型占比、本地/联网兜底次数，用于持续优化。
- **故障降级**: 外部依赖（LLM、联网搜索）不可用时，明确返回可读错误与兜底提示。

### 8.7 部署与发布（Deployment & Release）

- **配置即代码**: 生产配置通过环境变量注入，镜像不写死环境。
- **数据持久化**: SQLite 与 ChromaDB 必须挂载卷持久化；升级版本前执行数据备份。
- **回滚策略**: 发布失败可快速回滚到上一版本镜像，避免数据结构不可逆变更。
